{
  "generated": "2026-01-18 16:28:21",
  "discovery_method": "manual_exploration",
  "build_from": {
    "primary_file": "llm-env",
    "reason": "Main script containing all provider management logic, config parsing, and command handlers",
    "suggested_approach": [
      "Modify load_config() to parse new 'protocol' field with default 'openai'",
      "Add PROVIDER_PROTOCOLS associative array",
      "Update cmd_set() to handle protocol-specific variable exports",
      "Update cmd_unset() to clear both OpenAI and Anthropic variables",
      "Update cmd_test() to use protocol-specific headers",
      "Update cmd_list() to show protocol information"
    ]
  },
  "existing_patterns": [
    {
      "name": "Associative Array Pattern for Provider Storage",
      "description": "Uses associative arrays (PROVIDER_BASE_URLS, PROVIDER_API_KEY_VARS, PROVIDER_DEFAULT_MODELS, PROVIDER_DESCRIPTIONS, PROVIDER_ENABLED) to store provider configuration with wrapper functions for bash 3.2 compatibility",
      "files": ["llm-env"],
      "follow_for": "Follow this pattern to add PROVIDER_PROTOCOLS array and extend config parsing case statement"
    },
    {
      "name": "Config Parsing with Regex Pattern Matching",
      "description": "load_config() function uses regex patterns to parse INI-style config files, handling sections and key=value pairs",
      "files": ["llm-env:309-380"],
      "follow_for": "Add 'protocol' key to the case statement in config parsing"
    },
    {
      "name": "Bash 3.2 Compatibility Layer",
      "description": "Compatibility functions (compat_assoc_set, compat_assoc_get, etc.) are inlined directly in llm-env for single-file distribution",
      "files": ["llm-env:157-298"],
      "follow_for": "When adding PROVIDER_PROTOCOLS, must also handle bash 3.2 compatibility arrays"
    },
    {
      "name": "Variable Masking for Security",
      "description": "mask() function masks sensitive values showing only first/last characters",
      "files": ["llm-env:513-532"],
      "follow_for": "Apply same masking to ANTHROPIC_AUTH_TOKEN and ANTHROPIC_API_KEY in cmd_show()"
    }
  ],
  "related_files": [
    {
      "path": "llm-env",
      "relevance": "high",
      "purpose": "Main script containing all provider management logic, config parsing, and command handlers",
      "likely_modification": "modify"
    },
    {
      "path": "config/llm-env.conf",
      "relevance": "high",
      "purpose": "Built-in configuration template for providers",
      "likely_modification": "extend"
    }
  ],
  "integration_points": [
    {
      "location": "llm-env:load_config()",
      "type": "function",
      "description": "Config parsing function where 'protocol' field should be added to case statement"
    },
    {
      "location": "llm-env:init_config()",
      "type": "function",
      "description": "Initialization function where PROVIDER_PROTOCOLS associative array should be declared"
    },
    {
      "location": "llm-env:cmd_set()",
      "type": "function",
      "description": "Command handler where protocol-specific variable exports should be implemented"
    },
    {
      "location": "llm-env:cmd_unset()",
      "type": "function",
      "description": "Command handler where all protocol variables should be cleared"
    },
    {
      "location": "llm-env:cmd_test()",
      "type": "function",
      "description": "Command handler where protocol-specific headers for API testing should be implemented"
    },
    {
      "location": "llm-env:cmd_list()",
      "type": "function",
      "description": "Command handler where protocol column should be added to output"
    },
    {
      "location": "llm-env:cmd_show()",
      "type": "function",
      "description": "Command handler where Anthropic variables should be displayed with masking"
    }
  ],
  "reusable_components": [
    {
      "name": "mask() function",
      "path": "llm-env",
      "can_extend": true,
      "usage_example": "Apply to ANTHROPIC_AUTH_TOKEN and ANTHROPIC_API_KEY just like OPENAI_API_KEY"
    },
    {
      "name": "set_provider_value() / get_provider_value() wrapper functions",
      "path": "llm-env:236-288",
      "can_extend": true,
      "usage_example": "Use these to read/write PROVIDER_PROTOCOLS for bash 3.2 compatibility"
    }
  ],
  "architecture_notes": [
    "The codebase is primarily bash with some PowerShell modules for Windows support",
    "Associative array pattern with wrapper functions enables bash 3.2 compatibility (macOS default)",
    "Config precedence: user config > system config > built-in config",
    "All commands are designed to be sourced, not executed directly (except for initialization)",
    "The mask() function should be reused for Anthropic variable security"
  ],
  "files_to_modify": [
    {
      "path": "llm-env",
      "reason": "Main script - needs protocol field parsing, variable export logic, and command handler updates",
      "scope": "major"
    },
    {
      "path": "config/llm-env.conf",
      "reason": "Add example Anthropic provider with protocol=anthropic",
      "scope": "minor"
    }
  ],
  "files_to_create": [
    {
      "purpose": "Unit tests for protocol support",
      "based_on": "tests/unit/test_validation.bats",
      "path": "tests/unit/test_protocols.bats"
    }
  ],
  "test_patterns": {
    "framework": "bats",
    "test_location": "tests/unit",
    "naming_convention": "*.bats",
    "example_test": "tests/unit/test_validation.bats"
  }
}
